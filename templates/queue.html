{% extends "base.html" %}

{% block title %}Smart Queue - PetWeaver{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="hero-header">
            <h1 class="hero-title">ðŸ§  Smart Leveling Queue</h1>
            <p class="hero-subtitle">
                <i class="fas fa-layer-group me-2"></i>Optimize your leveling with bandage-efficient carry teams
            </p>
            <div class="animated-border"></div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Left: Configuration -->
    <div class="col-md-4 mb-4">
        <div class="card h-100 bg-dark border-secondary">
            <div class="card-header bg-dark text-white border-bottom border-secondary">
                <i class="fas fa-sliders-h me-2"></i>Configuration
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label text-white small">Leveling Pet</label>
                    <input type="text" class="form-control bg-black text-white border-secondary" id="levelingPetName"
                        placeholder="e.g. Mechanical Pandaren Dragonling">
                </div>
                <div class="mb-4">
                    <label class="form-label text-white small">Target Encounter</label>
                    <select class="form-select bg-black text-white border-secondary" id="targetEncounter">
                        <option value="squirt">Squirt (WoD Garrison)</option>
                        <option value="ashlei">Ashlei (Shadowmoon Valley)</option>
                        <option value="taralune">Taralune (Talador)</option>
                    </select>
                </div>
                <button class="btn btn-primary w-100" onclick="getNextTeam()">
                    <i class="fas fa-magic me-2"></i>Suggest Team
                </button>
            </div>
        </div>
    </div>

    <!-- Right: Recommendation -->
    <div class="col-md-8 mb-4">
        <div class="card h-100 bg-dark border-secondary">
            <div class="card-header bg-dark text-white border-bottom border-secondary">
                <i class="fas fa-star me-2"></i>Recommended Team
            </div>
            <div class="card-body d-flex flex-column justify-content-center" id="teamDisplay">
                <div class="text-center text-muted py-5">
                    <i class="fas fa-search fa-3x mb-3 opacity-50"></i>
                    <p>Select a pet and target to get a recommendation.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Stats -->
    <div class="col-md-4 mb-4">
        <div class="card h-100 bg-dark border-secondary">
            <div class="card-header bg-dark text-white border-bottom border-secondary">
                <i class="fas fa-chart-pie me-2"></i>Efficiency Stats
            </div>
            <div class="card-body text-center d-flex flex-column justify-content-center">
                <h6 class="text-muted mb-2">Bandage Efficiency</h6>
                <h2 id="efficiencyDisplay" class="text-success fw-bold display-4">100%</h2>
                <small class="text-muted">Based on last 10 battles</small>
            </div>
        </div>
    </div>

    <!-- Result Reporting (Mock) -->
    <div class="col-md-8 mb-4">
        <div class="card h-100 bg-dark border-secondary">
            <div class="card-header bg-dark text-white border-bottom border-secondary">
                <i class="fas fa-clipboard-check me-2"></i>Report Result
            </div>
            <div class="card-body d-flex align-items-center justify-content-between">
                <span class="text-white">Simulate Battle Result:</span>
                <div class="btn-group">
                    <button class="btn btn-outline-success" onclick="reportResult(true, 80)">
                        <i class="fas fa-check me-2"></i>Win (High HP)
                    </button>
                    <button class="btn btn-outline-warning" onclick="reportResult(true, 20)">
                        <i class="fas fa-exclamation-triangle me-2"></i>Win (Low HP)
                    </button>
                    <button class="btn btn-outline-danger" onclick="reportResult(false, 0)">
                        <i class="fas fa-times me-2"></i>Loss
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function getNextTeam() {
        const petName = document.getElementById('levelingPetName').value;
        const target = document.getElementById('targetEncounter').value;

        if (!petName) {
            alert("Please enter a leveling pet name.");
            return;
        }

        const display = document.getElementById('teamDisplay');
        display.innerHTML = '<div class="text-center py-5"><i class="fas fa-spinner fa-spin fa-2x text-white"></i></div>';

        try {
            const res = await fetch('/api/queue/next', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    leveling_pet: { name: petName, level: 1 },
                    target_id: target
                })
            });
            const data = await res.json();
            renderTeam(data);
        } catch (e) {
            display.innerHTML = '<div class="text-danger text-center">Error fetching team.</div>';
        }
    }

    function renderTeam(teamData) {
        const display = document.getElementById('teamDisplay');
        if (teamData.error) {
            display.innerHTML = `<div class="text-danger text-center"><i class="fas fa-exclamation-circle me-2"></i>${teamData.error}</div>`;
            return;
        }

        let html = `<div class="alert alert-info bg-dark border-info text-info mb-4"><i class="fas fa-info-circle me-2"></i> ${teamData.strategy_hint}</div>`;
        html += '<div class="row g-3">';

        teamData.pets.forEach((pet, idx) => {
            const isLeveling = idx === teamData.leveling_slot;
            const borderClass = isLeveling ? 'border-warning' : 'border-secondary';
            const bgClass = isLeveling ? 'bg-warning bg-opacity-10' : 'bg-black';
            const badge = isLeveling ? '<span class="badge bg-warning text-dark mb-2">Leveling</span>' : '<span class="badge bg-secondary mb-2">Carry</span>';

            html += `
                <div class="col-md-4">
                    <div class="card h-100 ${borderClass} ${bgClass}">
                        <div class="card-body text-center">
                            ${badge}
                            <h5 class="card-title text-white mb-1 text-truncate" title="${pet.name}">${pet.name}</h5>
                            <div class="text-muted small">Slot ${idx + 1}</div>
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';

        display.innerHTML = html;
    }

    async function reportResult(win, hp) {
        try {
            const res = await fetch('/api/queue/result', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ win: win, hp_remaining: hp })
            });
            const data = await res.json();
            updateEfficiency(data.efficiency);
        } catch (e) {
            console.error(e);
        }
    }

    function updateEfficiency(val) {
        const el = document.getElementById('efficiencyDisplay');
        el.innerText = Math.round(val) + '%';
        el.className = 'fw-bold display-4';
        if (val >= 80) el.classList.add('text-success');
        else if (val >= 50) el.classList.add('text-warning');
        else el.classList.add('text-danger');
    }
</script>
{% endblock %}