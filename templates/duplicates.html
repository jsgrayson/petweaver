{% extends "base.html" %}

{% block title %}Duplicate Analyzer - PetWeaver{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="hero-header">
            <h1 class="hero-title">ðŸ‘¯ Duplicate Analyzer</h1>
            <p class="hero-subtitle">
                <i class="fas fa-clone me-2"></i>Identify and manage duplicate pets in your collection
            </p>
            <div class="animated-border"></div>
        </div>
    </div>
</div>

<!-- Stats -->
<div class="row mb-4">
    <div class="col-md-4 mb-3">
        <div class="card widget-card h-100">
            <div class="card-body text-center">
                <h6 class="text-light mb-2"><i class="fas fa-paw me-2"></i>Duplicate Species</h6>
                <h2 class="mb-0 text-white fw-bold" id="statSpecies">0</h2>
                <small class="text-muted">Species with >1 copy</small>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card widget-card h-100 border-warning">
            <div class="card-body text-center">
                <h6 class="text-light mb-2"><i class="fas fa-exclamation-triangle me-2"></i>Total Excess Pets</h6>
                <h2 class="mb-0 text-warning fw-bold" id="statExcess">0</h2>
                <small class="text-warning">Copies to release</small>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card widget-card h-100 border-success">
            <div class="card-body text-center">
                <h6 class="text-light mb-2"><i class="fas fa-box-open me-2"></i>Potential Space</h6>
                <h2 class="mb-0 text-success fw-bold" id="statSpace">0</h2>
                <small class="text-success">Slots to reclaim</small>
            </div>
        </div>
    </div>
</div>

<!-- Duplicates List -->
<div class="row">
    <div class="col-md-12">
        <div class="card bg-dark border-secondary">
            <div class="card-body p-0">
                <div class="accordion accordion-flush" id="duplicatesContainer">
                    <!-- Populated by JS -->
                    <div class="text-center py-5">
                        <i class="fas fa-spinner fa-spin fa-2x text-muted mb-3"></i>
                        <p class="text-muted">Scanning collection for duplicates...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const BREED_NAMES = {
        3: "H/H", 4: "P/P", 5: "S/S", 6: "H/P", 7: "H/S", 8: "P/S", 9: "B/B", 10: "P/B", 11: "S/B", 12: "H/B"
    };

    const QUALITY_COLORS = {
        0: '#9d9d9d', // Poor
        1: '#ffffff', // Common
        2: '#1eff00', // Uncommon
        3: '#0070dd', // Rare
        4: '#a335ee', // Epic
        5: '#ff8000'  // Legendary
    };

    async function loadDuplicates() {
        try {
            const res = await fetch('/api/collection/duplicates');
            const data = await res.json();

            const container = document.getElementById('duplicatesContainer');
            container.innerHTML = '';

            if (data.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-check-circle fa-4x text-success mb-3"></i>
                        <h3 class="text-success">Clean Collection!</h3>
                        <p class="text-muted">No duplicate pets found.</p>
                    </div>
                `;
                return;
            }

            let totalExcess = 0;

            data.forEach((group, index) => {
                totalExcess += (group.count - 1);

                const headerId = `heading${index}`;
                const collapseId = `collapse${index}`;

                let petsHtml = '';
                group.pets.forEach((pet, i) => {
                    const isBest = i === 0; // Already sorted by Level/Quality
                    const bestClass = isBest ? 'border-success bg-success bg-opacity-10' : 'border-secondary bg-dark';
                    const bestBadge = isBest ? '<span class="badge bg-success float-end">Keep</span>' : '<span class="badge bg-danger float-end">Release?</span>';
                    const breedName = BREED_NAMES[pet.stats?.breedId] || 'Unknown';
                    const qualityColor = QUALITY_COLORS[pet.quality] || '#ffffff';

                    petsHtml += `
                        <div class="card mb-2 ${bestClass} border">
                            <div class="card-body py-2">
                                ${bestBadge}
                                <h6 class="card-title mb-1" style="color: ${qualityColor}">
                                    ${pet.name} <small class="text-muted ms-2">Lvl ${pet.level}</small>
                                </h6>
                                <div class="small text-muted d-flex gap-3">
                                    <span><i class="fas fa-dna me-1"></i>${breedName}</span>
                                    <span><i class="fas fa-heart me-1"></i>${pet.stats?.health}</span>
                                    <span><i class="fas fa-fist-raised me-1"></i>${pet.stats?.power}</span>
                                    <span><i class="fas fa-tachometer-alt me-1"></i>${pet.stats?.speed}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });

                const accordionItem = `
                    <div class="accordion-item bg-dark border-bottom border-secondary">
                        <h2 class="accordion-header" id="${headerId}">
                            <button class="accordion-button collapsed bg-dark text-white shadow-none" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}">
                                <div class="d-flex justify-content-between w-100 me-3">
                                    <span>${group.petName}</span>
                                    <span class="badge bg-warning text-dark">${group.count} Copies</span>
                                </div>
                            </button>
                        </h2>
                        <div id="${collapseId}" class="accordion-collapse collapse" data-bs-parent="#duplicatesContainer">
                            <div class="accordion-body bg-black">
                                <p class="small text-muted mb-2"><i class="fas fa-info-circle me-1"></i>Sorted by Level (High to Low), then Quality.</p>
                                ${petsHtml}
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += accordionItem;
            });

            // Update Stats
            document.getElementById('statSpecies').innerText = data.length;
            document.getElementById('statExcess').innerText = totalExcess;
            document.getElementById('statSpace').innerText = totalExcess; // 1 slot per pet

        } catch (e) {
            console.error(e);
            document.getElementById('duplicatesContainer').innerHTML = '<div class="text-center py-5 text-danger">Failed to load duplicates.</div>';
        }
    }

    // Init
    loadDuplicates();
</script>
{% endblock %}