<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PetWeaver - Duplicate Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background-color: #1a1d21;
            color: #e0e0e0;
        }

        .card {
            background-color: #2c3036;
            border-color: #444;
        }

        .navbar {
            background-color: #212529;
        }

        .best-pet {
            border: 2px solid #28a745;
            background-color: #1e3a23;
        }

        .quality-3 {
            color: #0070dd;
        }

        /* Rare */
        .quality-2 {
            color: #1eff00;
        }

        /* Uncommon */
        .quality-1 {
            color: #ffffff;
        }

        /* Common */
        .quality-0 {
            color: #9d9d9d;
        }

        /* Poor */
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="/">PetWeaver</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="/genetic">Genetic Builder</a></li>
                    <li class="nav-item"><a class="nav-link" href="/wishlist">Wishlist</a></li>
                    <li class="nav-item"><a class="nav-link" href="/market">Market Watcher</a></li>
                    <li class="nav-item"><a class="nav-link" href="/combat">Combat Log</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/duplicates">Duplicates</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <h2 class="mb-4"><i class="fas fa-clone text-info"></i> Duplicate Analyzer</h2>

        <!-- Stats -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card text-center p-3">
                    <div class="text-muted">Duplicate Species</div>
                    <h3 id="statSpecies">0</h3>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center p-3">
                    <div class="text-muted">Total Excess Pets</div>
                    <h3 id="statExcess" class="text-warning">0</h3>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center p-3">
                    <div class="text-muted">Potential Space</div>
                    <h3 id="statSpace" class="text-success">0</h3>
                </div>
            </div>
        </div>

        <!-- Duplicates List -->
        <div id="duplicatesContainer" class="accordion">
            <!-- Populated by JS -->
            <div class="text-center py-5">
                <i class="fas fa-spinner fa-spin fa-2x"></i><br>Scanning collection...
            </div>
        </div>
    </div>

    <script>
        const BREED_NAMES = {
            3: "H/H", 4: "P/P", 5: "S/S", 6: "H/P", 7: "H/S", 8: "P/S", 9: "B/B", 10: "P/B", 11: "S/B", 12: "H/B"
        };

        async function loadDuplicates() {
            try {
                const res = await fetch('/api/collection/duplicates');
                const data = await res.json();

                const container = document.getElementById('duplicatesContainer');
                container.innerHTML = '';

                if (data.length === 0) {
                    container.innerHTML = '<div class="alert alert-success text-center">No duplicates found! Your collection is clean.</div>';
                    return;
                }

                let totalExcess = 0;

                data.forEach((group, index) => {
                    totalExcess += (group.count - 1);

                    const headerId = `heading${index}`;
                    const collapseId = `collapse${index}`;

                    let petsHtml = '';
                    group.pets.forEach((pet, i) => {
                        const isBest = i === 0; // Already sorted by Level/Quality
                        const bestClass = isBest ? 'best-pet' : '';
                        const bestBadge = isBest ? '<span class="badge bg-success float-end">Keep</span>' : '<span class="badge bg-secondary float-end">Release?</span>';
                        const breedName = BREED_NAMES[pet.stats?.breedId] || 'Unknown';

                        petsHtml += `
                            <div class="card mb-2 ${bestClass}">
                                <div class="card-body py-2">
                                    ${bestBadge}
                                    <h6 class="card-title quality-${pet.quality}">${pet.name} <small class="text-muted">(Lvl ${pet.level})</small></h6>
                                    <div class="small text-muted">
                                        Breed: ${breedName} | HP: ${pet.stats?.health} | Power: ${pet.stats?.power} | Speed: ${pet.stats?.speed}
                                    </div>
                                </div>
                            </div>
                        `;
                    });

                    const accordionItem = `
                        <div class="accordion-item bg-dark border-secondary">
                            <h2 class="accordion-header" id="${headerId}">
                                <button class="accordion-button collapsed bg-dark text-light" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}">
                                    ${group.petName} <span class="badge bg-warning text-dark ms-2">${group.count} Copies</span>
                                </button>
                            </h2>
                            <div id="${collapseId}" class="accordion-collapse collapse" data-bs-parent="#duplicatesContainer">
                                <div class="accordion-body">
                                    ${petsHtml}
                                </div>
                            </div>
                        </div>
                    `;
                    container.innerHTML += accordionItem;
                });

                // Update Stats
                document.getElementById('statSpecies').innerText = data.length;
                document.getElementById('statExcess').innerText = totalExcess;
                document.getElementById('statSpace').innerText = totalExcess; // 1 slot per pet

            } catch (e) {
                console.error(e);
                document.getElementById('duplicatesContainer').innerHTML = '<div class="alert alert-danger">Failed to load duplicates.</div>';
            }
        }

        // Init
        loadDuplicates();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>