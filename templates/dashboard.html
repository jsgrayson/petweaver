<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Progress Dashboard - PetWeaver</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="container">
        <header>
            <div class="logo">
                <h1>PetWeaver Dashboard</h1>
            </div>
            <button id="nav-toggle" class="hamburger" aria-label="Toggle navigation">
                <span></span><span></span><span></span>
            </button>
            <nav id="main-nav" class="nav-collapsed">
                <a href="/">Home</a>
                <a href="/dashboard" class="active">Dashboard</a>
                <a href="/strategies">Strategies</a>
                <a href="/wizard">Wizard</a>
                <a href="/hunting">Hunting</a>
                <a href="/leveling">Leveling</a>
            </nav>
        </header>
        </header>

        <main>
            <!-- Quick Stats -->
            <div class="grid">
                <div class="card stat-card">
                    <h3>Ready Encounters</h3>
                    <div class="value highlight" id="ready-count">0</div>
                    <span class="subtext">Can do now</span>
                </div>
                <div class="card stat-card">
                    <h3>Total Encounters</h3>
                    <div class="value" id="total-count">0</div>
                    <span class="subtext">In database</span>
                </div>
                <div class="card stat-card">
                    <h3>Completion Rate</h3>
                    <div class="value" id="completion-rate">0%</div>
                    <span class="subtext">Progress</span>
                </div>
            </div>

            <!-- Collection Health Score -->
            <div class="card">
                <h2>üè• Collection Health Score</h2>
                <div id="health-score">
                    <div class="loading">Analyzing collection...</div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="grid">
                <div class="card chart-card">
                    <h3>Ready by Expansion</h3>
                    <canvas id="expansionChart"></canvas>
                </div>
                <div class="card chart-card">
                    <h3>Ready by Category</h3>
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>

            <!-- Recommendations -->
            <div class="card">
                <h2>üéØ Recommended: Do These Next</h2>
                <div id="recommendations">
                    <div class="loading">Loading recommendations...</div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let expansionChart, categoryChart;

        function loadAnalytics() {
            fetch('/api/analytics')
                .then(res => res.json())
                .then(data => {
                    // Update stats
                    document.getElementById('ready-count').innerText = data.readyEncounters;
                    document.getElementById('total-count').innerText = data.totalEncounters;
                    const rate = data.totalEncounters > 0 ?
                        ((data.readyEncounters / data.totalEncounters) * 100).toFixed(1) : 0;
                    document.getElementById('completion-rate').innerText = rate + '%';

                    // Expansion Chart
                    const expCtx = document.getElementById('expansionChart').getContext('2d');
                    if (expansionChart) expansionChart.destroy();
                    expansionChart = new Chart(expCtx, {
                        type: 'bar',
                        data: {
                            labels: Object.keys(data.readyByExpansion),
                            datasets: [{
                                label: 'Ready Encounters',
                                data: Object.values(data.readyByExpansion),
                                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            scales: {
                                y: { beginAtZero: true }
                            },
                            onClick: (event, elements) => {
                                if (elements.length > 0) {
                                    const index = elements[0].index;
                                    const expansion = Object.keys(data.readyByExpansion)[index];
                                    // Navigate to strategies page with expansion filter
                                    window.location.href = `/strategies?expansion=${encodeURIComponent(expansion)}`;
                                }
                            },
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        afterLabel: () => 'Click to view strategies'
                                    }
                                }
                            }
                        }
                    });

                    // Category Chart
                    const catCtx = document.getElementById('categoryChart').getContext('2d');
                    if (categoryChart) categoryChart.destroy();
                    categoryChart = new Chart(catCtx, {
                        type: 'doughnut',
                        data: {
                            labels: Object.keys(data.readyByCategory),
                            datasets: [{
                                data: Object.values(data.readyByCategory),
                                backgroundColor: [
                                    'rgba(255, 99, 132, 0.6)',
                                    'rgba(54, 162, 235, 0.6)',
                                    'rgba(255, 206, 86, 0.6)',
                                    'rgba(75, 192, 192, 0.6)',
                                    'rgba(153, 102, 255, 0.6)',
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            onClick: (event, elements) => {
                                if (elements.length > 0) {
                                    const index = elements[0].index;
                                    const category = Object.keys(data.readyByCategory)[index];
                                    // Navigate to strategies page with category filter
                                    window.location.href = `/strategies?category=${encodeURIComponent(category)}`;
                                }
                            },
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        afterLabel: () => 'Click to view strategies'
                                    }
                                }
                            }
                        }
                    });
                });
        }

        function loadRecommendations() {
            fetch('/api/recommendations')
                .then(res => res.json())
                .then(data => {
                    const container = document.getElementById('recommendations');
                    if (data.length === 0) {
                        container.innerHTML = '<div class="empty">No recommendations available</div>';
                        return;
                    }

                    container.innerHTML = data.map((rec, i) => `
                        <div class="recommendation-item">
                            <span class="rank">#${i + 1}</span>
                            <div class="rec-info">
                                <strong>${rec.name}</strong>
                                <span class="rec-meta">${rec.expansion} ‚Ä¢ ${rec.category}</span>
                            </div>
                            <span class="rec-reason">${rec.reason}</span>
                        </div>
                    `).join('');
                });
        }

        function loadCollectionHealth() {
            fetch('/api/analytics/collection-health')
                .then(res => res.json())
                .then(data => {
                    const container = document.getElementById('health-score');

                    // Get score color
                    let scoreColor = 'var(--error)';
                    if (data.overall_score >= 80) scoreColor = 'var(--success)';
                    else if (data.overall_score >= 60) scoreColor = 'var(--warning)';

                    // Build family coverage heatmap
                    const families = Object.entries(data.family_coverage).sort((a, b) => b[1].owned - a[1].owned);
                    const maxOwned = Math.max(...families.map(([_, f]) => f.owned));

                    container.innerHTML = `
                        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 2rem; margin-top: 1rem;">
                            <!-- Score Ring -->
                            <div style="text-align: center;">
                                <div style="position: relative; width: 150px; height: 150px; margin: 0 auto;">
                                    <svg viewBox="0 0 100 100" style="transform: rotate(-90deg);">
                                        <circle cx="50" cy="50" r="45" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="10"/>
                                        <circle cx="50" cy="50" r="45" fill="none" stroke="${scoreColor}" stroke-width="10" 
                                                stroke-dasharray="${data.overall_score * 2.827}, 282.7" stroke-linecap="round"/>
                                    </svg>
                                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                                        <div style="font-size: 2rem; font-weight: bold; color: ${scoreColor};">${data.overall_score}</div>
                                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: -5px;">SCORE</div>
                                    </div>
                                </div>
                                <div style="margin-top: 1rem; font-size: 0.9rem;">
                                    <div style="color: var(--text-muted);">Diversity: ${data.diversity_score}%</div>
                                    <div style="color: var(--text-muted);">Completeness: ${data.completeness_score}%</div>
                                    <div style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-muted);">
                                        ${data.total_owned} pets owned
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Family Coverage & Top Missing -->
                            <div>
                                <h4 style="margin: 0 0 1rem 0;">Pet Family Coverage</h4>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-bottom: 1.5rem;">
                                    ${families.map(([family, data]) => {
                        const percentage = maxOwned > 0 ? (data.owned / maxOwned) * 100 : 0;
                        return `
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <div style="min-width: 80px; font-size: 0.85rem;">${family}</div>
                                                <div style="flex: 1; height: 20px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
                                                    <div style="height: 100%; background: var(--primary); width: ${percentage}%;"></div>
                                                </div>
                                                <div style="min-width: 30px; font-size: 0.85rem; text-align: right; color: var(--text-muted);">${data.owned}</div>
                                            </div>
                                        `;
                    }).join('')}
                                </div>
                                
                                ${data.missing_high_value.length > 0 ? `
                                    <h4 style="margin: 1.5rem 0 1rem 0;">üéØ Top Missing Pets (High Value)</h4>
                                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                        ${data.missing_high_value.slice(0, 5).map(pet => `
                                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(239, 68, 68, 0.1); border-radius: 4px; border-left: 3px solid var(--error);">
                                                <span style="font-weight: 500;">${pet.name}</span>
                                                <span style="color: var(--error);">Unlocks ${pet.unlocks} strategies</span>
                                                <a href="${pet.warcraftpets_url}" target="_blank" style="color: var(--link); text-decoration: underline;">View</a>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                })
                .catch(err => {
                    console.error('Error loading collection health:', err);
                    document.getElementById('health-score').innerHTML = '<div class="error">Failed to load health data</div>';
                });
        }

        // Load all data on page load
        loadCollectionHealth();
        loadAnalytics();
        loadRecommendations();
    </script>
</body>

</html>