{% extends "base.html" %}

{% block title %}Breed Wishlist - PetWeaver{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="hero-header">
            <h1 class="hero-title">❤️ Breed Wishlist</h1>
            <p class="hero-subtitle">
                <i class="fas fa-heart me-2"></i>Track specific breeds you want to capture
            </p>
            <div class="animated-border"></div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Add New Item -->
    <div class="col-md-4">
        <div class="card mb-4 h-100">
            <div class="card-header bg-dark text-white">
                <i class="fas fa-plus-circle me-2"></i>Add to Wishlist
            </div>
            <div class="card-body">
                <form id="addForm">
                    <div class="mb-3">
                        <label class="form-label text-white">Species ID</label>
                        <input type="number" class="form-control bg-dark text-white border-secondary" id="speciesId"
                            required placeholder="e.g. 71163">
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-white">Pet Name</label>
                        <input type="text" class="form-control bg-dark text-white border-secondary" id="petName"
                            placeholder="Optional">
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-white">Desired Breed</label>
                        <select class="form-select bg-dark text-white border-secondary" id="breedId">
                            <option value="3">3 (H/H)</option>
                            <option value="4">4 (P/P)</option>
                            <option value="5">5 (S/S)</option>
                            <option value="6">6 (H/P)</option>
                            <option value="7">7 (H/S)</option>
                            <option value="8">8 (P/S)</option>
                            <option value="9">9 (B/B)</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-plus me-2"></i>Add Item
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Wishlist Items -->
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                <span><i class="fas fa-list me-2"></i>My Wishlist</span>
                <button onclick="exportForAddon()" class="btn btn-sm btn-outline-info">
                    <i class="fas fa-file-export me-2"></i>Export for Addon
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-dark table-hover mb-0 align-middle">
                        <thead>
                            <tr>
                                <th class="ps-3">Pet</th>
                                <th>ID</th>
                                <th>Breed</th>
                                <th>Added</th>
                                <th class="text-end pe-3">Action</th>
                            </tr>
                        </thead>
                        <tbody id="wishlistTable">
                            <!-- Items populated by JS -->
                            <tr>
                                <td colspan="5" class="text-center py-4 text-muted">Loading wishlist...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Simulation Tool -->
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
                <i class="fas fa-flask me-2"></i>Wild Pet Scanner Simulation
            </div>
            <div class="card-body">
                <p class="small text-muted mb-3">Simulate finding a wild pet to test alerts.</p>
                <div class="row g-2 align-items-center">
                    <div class="col-md-4">
                        <input type="number" class="form-control bg-dark text-white border-secondary" id="simSpeciesId"
                            placeholder="Species ID">
                    </div>
                    <div class="col-md-4">
                        <select class="form-select bg-dark text-white border-secondary" id="simBreedId">
                            <option value="3">3 (H/H)</option>
                            <option value="4">4 (P/P)</option>
                            <option value="5">5 (S/S)</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <button onclick="simulateScan()" class="btn btn-outline-warning w-100">Simulate Scan</button>
                    </div>
                </div>
                <div id="scanAlert" class="alert mt-3" style="display: none;"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Load Wishlist
    async function loadWishlist() {
        const res = await fetch('/api/wishlist');
        const data = await res.json();
        const tbody = document.getElementById('wishlistTable');

        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">Wishlist is empty</td></tr>';
            return;
        }

        tbody.innerHTML = '';
        data.forEach(item => {
            const row = `
                <tr>
                    <td class="ps-3 fw-bold text-white">${item.petName}</td>
                    <td class="text-muted">${item.speciesId}</td>
                    <td><span class="badge bg-info text-dark">${item.breedName}</span></td>
                    <td class="text-muted small">${new Date(item.addedAt).toLocaleDateString()}</td>
                    <td class="text-end pe-3">
                        <button onclick="deleteItem(${item.speciesId}, ${item.breedId})" class="btn btn-sm btn-outline-danger" title="Remove">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    // Add Item
    document.getElementById('addForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const speciesId = document.getElementById('speciesId').value;
        const petName = document.getElementById('petName').value || 'Unknown Pet';
        const breedSelect = document.getElementById('breedId');
        const breedId = breedSelect.value;
        const breedName = breedSelect.options[breedSelect.selectedIndex].text;

        const res = await fetch('/api/wishlist', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ speciesId, petName, breedId, breedName })
        });

        const result = await res.json();
        if (result.status === 'success') {
            loadWishlist();
            document.getElementById('addForm').reset();
        } else {
            alert(result.message);
        }
    });

    // Delete Item
    async function deleteItem(speciesId, breedId) {
        if (!confirm('Remove from wishlist?')) return;

        await fetch('/api/wishlist', {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ speciesId, breedId })
        });
        loadWishlist();
    }

    // Simulate Scan
    async function simulateScan() {
        const speciesId = document.getElementById('simSpeciesId').value;
        const breedId = document.getElementById('simBreedId').value;

        const res = await fetch('/api/scan_wild_pet', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ speciesId, breedId })
        });

        const result = await res.json();
        const alertBox = document.getElementById('scanAlert');

        if (result.alert) {
            alertBox.className = 'alert alert-success mt-3';
            alertBox.innerHTML = `<i class="fas fa-check-circle me-2"></i><strong>MATCH FOUND!</strong><br>${result.message}`;
            alertBox.style.display = 'block';
        } else {
            alertBox.className = 'alert alert-secondary mt-3';
            alertBox.innerHTML = '<i class="fas fa-times-circle me-2"></i>No match found.';
            alertBox.style.display = 'block';
        }
    }

    // Export for Addon
    async function exportForAddon() {
        const res = await fetch('/api/wishlist');
        const data = await res.json();
        const exportStr = data.map(i => `${i.speciesId}:${i.breedId}`).join(',');
        prompt("Copy this string for PetWeaver addon (/petweaver import):", exportStr);
    }

    // Init
    loadWishlist();
</script>
{% endblock %}