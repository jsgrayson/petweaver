<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PetWeaver Desktop</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <div class="container">
        <header>
            <div class="logo">
                <h1>PetWeaver</h1>
                <span class="badge">PRO</span>
            </div>
            <nav>
                <a href="/" class="active">Home</a>
                <a href="/dashboard">Dashboard</a>
                <a href="/strategies">Strategies</a>
                <a href="/hunting">Hunting</a>
                <a href="/leveling">Leveling</a>
                <a href="/calendar">Calendar</a>
            </nav>
            <div class="status-indicator" id="status-badge">IDLE</div>
        </header>

        <main>
            <!-- Stats Grid -->
            <div class="grid">
                <div class="card stat-card">
                    <h3>My Pets</h3>
                    <div class="value" id="stat-pets">0</div>
                </div>
                <div class="card stat-card">
                    <h3>Strategies</h3>
                    <div class="value" id="stat-strategies">0</div>
                </div>
                <div class="card stat-card">
                    <h3>Ready to Battle</h3>
                    <div class="value highlight" id="stat-ready">0</div>
                </div>
            </div>
            <div class="card">
                <h2>Upcoming Events</h2>
                <div id="upcoming-events">Loading...</div>
            </div>

            <!-- Controls -->
            <div class="card controls-card">
                <h2>Automation Controls</h2>
                <div class="options">
                    <label class="toggle">
                        <input type="checkbox" id="skip-fetch" checked>
                        <span class="slider"></span>
                        <span class="label-text">Skip Blizzard Fetch (Use Local)</span>
                    </label>
                    <label class="toggle">
                        <input type="checkbox" id="force-scrape">
                        <span class="slider"></span>
                        <span class="label-text">Force Re-Scrape</span>
                    </label>
                </div>
                <div class="input-group">
                    <label>Addon Path</label>
                    <input type="text" id="addon-path" value="{{ default_path }}"
                        placeholder="/path/to/AddOns/PetWeaver">
                </div>
                <button id="btn-run" class="btn-primary" onclick="runAutomation()">
                    <span class="icon">▶</span> SYNC STRATEGIES
                </button>
            </div>

            <!-- Console -->
            <div class="card console-card">
                <div class="console-header">
                    <h3>Activity Log</h3>
                    <span id="last-update">Last Update: Never</span>
                </div>
                <div class="console-output" id="console-log">
                    <div class="log-entry">Waiting for command...</div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let isRunning = false;

        function updateStatus() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    // Update Stats
                    document.getElementById('stat-pets').innerText = data.stats.pets;
                    document.getElementById('stat-strategies').innerText = data.stats.strategies;
                    document.getElementById('stat-ready').innerText = data.stats.ready;
                    document.getElementById('last-update').innerText = data.last_update || 'Never';

                    // Update Status Badge
                    const badge = document.getElementById('status-badge');
                    badge.innerText = data.status;
                    badge.className = 'status-indicator ' + data.status.toLowerCase();

                    // Update Log
                    const logDiv = document.getElementById('console-log');
                    logDiv.innerHTML = data.log.map(line => `<div class="log-entry">${line}</div>`).join('');

                    // Auto scroll if running
                    if (data.status === 'RUNNING') {
                        logDiv.scrollTop = logDiv.scrollHeight;
                        document.getElementById('btn-run').disabled = true;
                        document.getElementById('btn-run').innerText = 'RUNNING...';
                        isRunning = true;
                    } else {
                        if (isRunning) {
                            document.getElementById('btn-run').disabled = false;
                            document.getElementById('btn-run').innerHTML = '<span class="icon">▶</span> SYNC STRATEGIES';
                            isRunning = false;
                        }
                    }
                });
        }

        function runAutomation() {
            const skipFetch = document.getElementById('skip-fetch').checked;
            const forceScrape = document.getElementById('force-scrape').checked;
            const addonPath = document.getElementById('addon-path').value;

            fetch('/api/run', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    skip_fetch: skipFetch,
                    force_scrape: forceScrape,
                    addon_path: addonPath
                })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.error) alert(data.error);
                    updateStatus();
                });
        }

        // Load upcoming events for calendar
        function loadUpcomingEvents() {
            fetch('/api/calendar')
                .then(r => r.json())
                .then(data => {
                    const container = document.getElementById('upcoming-events');
                    if (!container) return;
                    container.innerHTML = data.map(item => {
                        const squirt = item.is_squirt ? '✅' : '';
                        const pbw = item.is_pet_battle_week ? '✅' : '';
                        return `<div>${item.date} (${item.weekday}) ${squirt} ${pbw}</div>`;
                    }).join('');
                })
                .catch(err => {
                    console.error('Failed to load calendar', err);
                });
        }

        // Poll every 1 second
        setInterval(() => {
            updateStatus();
            loadUpcomingEvents();
        }, 1000);
        updateStatus();
        loadUpcomingEvents();
    </script>
</body>

</html>