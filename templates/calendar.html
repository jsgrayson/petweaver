{% extends "base.html" %}

{% block title %}Calendar - PetWeaver{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="hero-header">
            <h1 class="hero-title">ðŸ“… Event Calendar</h1>
            <p class="hero-subtitle">
                <i class="fas fa-calendar-alt me-2"></i>Track Squirt days and Pet Battle bonus events
            </p>
            <div class="animated-border"></div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card h-100">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                <h3 id="month-label" class="mb-0">Loading...</h3>
                <div class="btn-group">
                    <button id="prev-month" class="btn btn-outline-light btn-sm"><i class="fas fa-chevron-left"></i>
                        Prev</button>
                    <button id="today-btn" class="btn btn-outline-light btn-sm">Today</button>
                    <button id="next-month" class="btn btn-outline-light btn-sm">Next <i
                            class="fas fa-chevron-right"></i></button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-dark table-bordered mb-0 text-center" id="calendar-table"
                        style="table-layout: fixed;">
                        <thead>
                            <tr>
                                <th class="py-3 text-danger">Sun</th>
                                <th class="py-3">Mon</th>
                                <th class="py-3">Tue</th>
                                <th class="py-3">Wed</th>
                                <th class="py-3">Thu</th>
                                <th class="py-3">Fri</th>
                                <th class="py-3">Sat</th>
                            </tr>
                        </thead>
                        <tbody style="height: 500px;">
                            <tr>
                                <td colspan="7" class="text-center py-5">
                                    <i class="fas fa-spinner fa-spin fa-2x text-muted mb-3"></i>
                                    <p class="text-muted">Loading calendar data...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Calendar navigation state
    let monthOffset = 0; // 0 = current month
    const monthLabel = document.getElementById('month-label');
    const prevBtn = document.getElementById('prev-month');
    const todayBtn = document.getElementById('today-btn');
    const nextBtn = document.getElementById('next-month');

    function formatMonth(date) {
        const options = { year: 'numeric', month: 'long' };
        return date.toLocaleDateString(undefined, options);
    }

    function getMonthParam(offset) {
        const now = new Date();
        const target = new Date(now.getFullYear(), now.getMonth() + offset, 1);
        const year = target.getFullYear();
        const month = String(target.getMonth() + 1).padStart(2, '0');
        return `${year}-${month}`;
    }

    function loadCalendar() {
        const monthParam = getMonthParam(monthOffset);
        monthLabel.textContent = formatMonth(new Date(monthParam + '-01'));

        // Add loading state
        const tbody = document.querySelector('#calendar-table tbody');
        tbody.style.opacity = '0.5';

        fetch(`/api/calendar?month=${monthParam}`)
            .then(r => r.json())
            .then(data => {
                tbody.innerHTML = '';
                tbody.style.opacity = '1';

                const today = new Date().toISOString().split('T')[0];
                let week = [];

                // Pad start of month
                if (data.length > 0) {
                    const firstDate = new Date(data[0].date);
                    const startDay = firstDate.getUTCDay(); // 0=Sun
                    for (let i = 0; i < startDay; i++) {
                        week.push(null);
                    }
                }

                data.forEach(item => {
                    week.push(item);
                    if (week.length === 7) {
                        renderWeek(week);
                        week = [];
                    }
                });

                // Pad end of month
                if (week.length > 0) {
                    while (week.length < 7) week.push(null);
                    renderWeek(week);
                }
            })
            .catch(err => {
                console.error('Failed to load calendar data.', err);
                tbody.innerHTML = `<tr><td colspan="7" class="text-danger text-center py-5">Error loading calendar.</td></tr>`;
                tbody.style.opacity = '1';
            });
    }

    function renderWeek(days) {
        const tbody = document.querySelector('#calendar-table tbody');
        const tr = document.createElement('tr');
        const today = new Date().toISOString().split('T')[0];

        days.forEach(cell => {
            const td = document.createElement('td');
            td.style.height = '100px';
            td.style.verticalAlign = 'top';

            if (cell) {
                const isToday = cell.date === today;
                if (isToday) {
                    td.classList.add('bg-primary', 'bg-opacity-25');
                }

                // Format date number
                const dateNum = cell.date.split('-')[2];

                let content = `<div class="d-flex justify-content-between mb-2">
                    <span class="${isToday ? 'fw-bold text-white' : 'text-muted'}">${dateNum}</span>
                </div>`;

                if (cell.is_squirt) {
                    content += `<div class="badge bg-info text-dark w-100 mb-1" title="Squirt Day!"><i class="fas fa-tint me-1"></i> Squirt</div>`;
                }

                if (cell.is_pet_battle_week) {
                    content += `<div class="badge bg-warning text-dark w-100" title="Pet Battle Bonus Event"><i class="fas fa-paw me-1"></i> Bonus</div>`;
                }

                td.innerHTML = content;
            } else {
                td.classList.add('bg-secondary', 'bg-opacity-10');
            }
            tr.appendChild(td);
        });
        tbody.appendChild(tr);
    }

    // Button event listeners
    prevBtn.addEventListener('click', () => { monthOffset--; loadCalendar(); });
    todayBtn.addEventListener('click', () => { monthOffset = 0; loadCalendar(); });
    nextBtn.addEventListener('click', () => { monthOffset++; loadCalendar(); });

    // Initial load
    loadCalendar();
</script>
{% endblock %}